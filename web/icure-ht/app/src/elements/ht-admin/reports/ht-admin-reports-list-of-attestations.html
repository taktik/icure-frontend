<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../../../../bower_components/iron-iconset/iron-iconset.html">

<link rel="import" href="../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/device-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../../bower_components/iron-collapse-button/iron-collapse-button.html">
<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../dialog-style.html">

<dom-module id="ht-admin-reports-list-of-attestations">

    <template>

        <style include="shared-styles dialog-style">
            :host {
                display: block;
            }

            :host *:focus{
                outline:0!important;
            }

            .list-of-attestations{
                height: calc(100vh - 84px);
                width: 100%;
                padding: 0 20px 24px 20px;
                box-sizing: border-box;
                position: relative;
            }

           .form, .form-boxes{
                display:flex;
                flex-flow: row wrap;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 24px;
            }

            .form vaadin-date-picker{
                flex-grow: 1;
            }

            .form vaadin-combo-box{
                flex-grow: 2;
                padding: 0 8px 0 0;
                box-sizing: border-box;
            }

            .form-boxes{
                justify-content: flex-start;
                padding: 16px;
                border-radius: 3px;
                background: var(--app-background-color-dark);
            }

            .form-boxes paper-checkbox{
                margin-right: 24px;
            }

            vaadin-grid{
                margin-bottom: 24px;
                border-radius: 3px;
            }

            paper-checkbox{
                --paper-checkbox-focus-color: var(--app-secondary-color);
            }

            .full-height {
                height: 100%;
            }
            .full-width {
                width: 100%;
            }

            .flex {
                display: flex;
            }
            .grow-1 {
                flex-grow: 1;
            }
            .col {
                flex-direction: column;
            }
            .space-between {
                justify-content: space-between;
            }

            .anon-check {
                padding-top: 12px;
            }
            .export-btn {
                margin-right: 0;
            }

            @media screen and (max-width: 1024px) {
                .list-of-attestations{
                    width: 100vw;
                }

                .form-boxes {
                    overflow-x: auto;
                    overflow-y: auto;
                    flex-direction: column;
                }
            }

        </style>

        <div class="list-of-attestations flex col">
            <h4>[[localize('rap_att_list', 'Rapports - List of attestations', language)]]</h4>
            <div class="flex">
                <div class="form flex col">
                    <div class="flex full-width">
                        <vaadin-date-picker id="date-picker" label="[[localize('from2', 'Du', language)]]" value="{{dateFrom}}" i18n="[[i18n]]" on-value-changed="_checkIsDeadline"></vaadin-date-picker>
                        <vaadin-date-picker id="date-picker" label="[[localize('to2', 'Au', language)]]" value="{{dateTo}}" i18n="[[i18n]]" on-value-changed="_checkIsDeadline"></vaadin-date-picker>
                    </div>
                    <vaadin-combo-box class="full-width" filtered-items="[[hcpListItem]]" id="hcp-list" item-label-path="name" item-value-path="id" on-filter-changed="_hcpFilterChanged" on-value-changed="filterInvoiceList" selected-item="{{selectedHcpItem}}" label="Prestataire" readonly="[[readonly]]"></vaadin-combo-box>
                </div>

                <div class="form-boxes flex grow-1 space-between">
                    <div class="flex col space-between full-height">
                        <paper-checkbox checked="{{invoiceType_mutualfund}}">[[localize('mut', "Mutuelle", language)]]</paper-checkbox>
                        <paper-checkbox checked="{{invoiceType_patient}}">[[localize('inv_pat', "Patient", language)]]</paper-checkbox>
                        <paper-checkbox checked="{{invoiceType_others}}">[[localize('oth_orgs', "Autres Organismes", language)]]</paper-checkbox>
                    </div>
                    <div class="flex col space-between full-height">
                        <paper-checkbox checked="{{sentMediumType_eattest}}">e-Attest</paper-checkbox>
                        <paper-checkbox checked="{{sentMediumType_efact}}">e-Fact</paper-checkbox>
                        <paper-checkbox checked="{{sentMediumType_mediprima}}">Mediprima</paper-checkbox>
                        <paper-checkbox checked="{{sentMediumType_paper}}">[[localize('paper', "Papier", language)]]</paper-checkbox>
                    </div>
                    <div class="flex col space-between full-height">
                        <paper-checkbox checked="{{paymentType_cash}}">[[localize('cash','Cash',language)]]</paper-checkbox>
                        <paper-checkbox checked="{{paymentType_debitcard}}">[[localize('card_flow','Card flow',language)]]</paper-checkbox>
                        <paper-checkbox checked="{{paymentType_creditcard}}">[[localize('card_credit','Credit card',language)]]</paper-checkbox>
                        <paper-checkbox checked="{{paymentType_wired}}">[[localize('transfer','Transfert',language)]]</paper-checkbox>
                    </div>
                </div>
            </div>

            <vaadin-grid id="invoiceGrid" class="material grow-1" items="[[filteredInvoiceItems]]" active-item="{{selectedInvoice}}">
                <vaadin-grid-column flex-grow="0" width="48px">
                    <template class="header">
                        <vaadin-checkbox checked$="[[allSelected]]" on-tap="_toggleSelectAll"></vaadin-checkbox>
                    </template>
                    <template>
                            <vaadin-checkbox data-item$="[[item]]" on-checked-changed="_itemSelected" class="list-checkbox"></vaadin-checkbox>
                    </template>
                </vaadin-grid-column>
                <vaadin-grid-column>
                    <template class="header">
                        [[localize('persphysicianRole','Persphysician',language)]]
                    </template>
                    <template>
                        <div>[[item.author]]</div>
                    </template>
                </vaadin-grid-column>
                <vaadin-grid-column>
                    <template class="header">
                        [[localize('dat','Date',language)]]
                    </template>
                    <template>
                        <div>[[item.date]]</div>
                    </template>
                </vaadin-grid-column>
                <vaadin-grid-column>
                    <template class="header">
                        [[localize('inv_pat','Patient',language)]]
                    </template>
                    <template>
                        <div>[[item.patient]]</div>
                    </template>
                </vaadin-grid-column>
                <vaadin-grid-column>
                    <template class="header">
                        [[localize('cert_num','Certificate n°',language)]]
                    </template>
                    <template>
                        <div>[[item.invoiceReference]]</div>
                    </template>
                </vaadin-grid-column>
                <vaadin-grid-column>
                    <template class="header">
                        O.A.
                    </template>
                    <template>
                        <div>[[item.oa]]</div>
                    </template>
                </vaadin-grid-column>
                <vaadin-grid-column>
                    <template class="header">
                        [[localize('inv_mut','Mutual',language)]]
                    </template>
                    <template>
                        <div>[[item.insurance]]</div>
                    </template>
                </vaadin-grid-column>
                <vaadin-grid-column>
                    <template class="header">
                        [[localize('inv_smt','Sent medium type',language)]]
                    </template>
                    <template>
                        <div>[[item.sentMediumType]]</div>
                    </template>
                </vaadin-grid-column>
                <vaadin-grid-column>
                    <template class="header">
                        [[localize('fac_type','Billing type',language)]]
                    </template>
                    <template>
                        <div>[[item.invoiceType]]</div>
                    </template>
                </vaadin-grid-column>
                <!--
                <vaadin-grid-column>
                    <template class="header">
                        Convention liée
                    </template>
                    <template>
                        <div>[[item.linkedConvention]]</div>
                    </template>
                </vaadin-grid-column>
                -->
                <vaadin-grid-column>
                    <template class="header">
                        [[localize('fac_mode','Billing mode',language)]]
                    </template>
                    <template>
                        <div>[[item.paymentType]]</div>
                    </template>
                </vaadin-grid-column>
                <vaadin-grid-column>
                    <template class="header">
                        [[localize('cash','Cash',language)]]
                    </template>
                    <template>
                        <div>[[item.cash]]</div>
                    </template>
                </vaadin-grid-column>
                <vaadin-grid-column>
                    <template class="header">
                        [[localize('card_flow','Flow card',language)]]
                    </template>
                    <template>
                        <div>[[item.debitCard]]</div>
                    </template>
                </vaadin-grid-column>
                <vaadin-grid-column>
                    <template class="header">
                        [[localize('card_credit','Credit card',language)]]
                    </template>
                    <template>
                        <div>[[item.creditCard]]</div>
                    </template>
                </vaadin-grid-column>
                <vaadin-grid-column>
                    <template class="header">
                        [[localize('transfer','Transfert',language)]]
                    </template>
                    <template>
                        <div>[[item.wired]]</div>
                    </template>
                </vaadin-grid-column>
                <vaadin-grid-column>
                    <template class="header">
                        [[localize('tot_amount','Total amount',language)]]
                    </template>
                    <template>
                        <div>[[item.totalAmount]]</div>
                    </template>
                </vaadin-grid-column>
            </vaadin-grid>

            <div class="flex space-between">
                <paper-checkbox class="anon-check" checked="{{isExportAnonyme}}">[[localize('anon_export','Anonymous export',language)]]</paper-checkbox>
                <paper-button on-tap="exportToCsv" class="modal-button modal-button--save export-btn">[[localize('export','Export',language)]]</paper-button>
            </div>

        </div>

    </template>

    <script>

        import moment from 'moment/src/moment';
        import _ from 'lodash/lodash';
        import * as models from 'icc-api/dist/icc-api/model/models'

        import '../../../../bower_components/js-xlsx/shim.js'

        const XLSX = require('../../../../bower_components/js-xlsx/dist/xlsx.full.min.js')

        class HtAdminReportsListOfAttestations extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'ht-admin-reports-list-of-attestations'
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        noReset: true
                    },
                    user: {
                        type: Object,
                        noReset: true
                    },
                    invoiceItems: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    checkedInvoices: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                    isExportAnonyme: {
                        type: Boolean,
                        value: false
                    },

                    dateFrom: {
                        type: String,
                        value: ""
                    },

                    dateTo: {
                        type: String,
                        value: ""
                    },

                    paymentTypes: {
                        type: Array,
                        value: () => [
                            {
                                id: "wired",
                                label: {"fr": "Virement", "nl": "Overschrijving", "en": "Wired"}
                            },
                            {
                                id: "cash",
                                label: {"fr": "En espèces", "nl": "Cash", "en": "Cash"}
                            },
                            {
                                id: "debitcard",
                                label: {"fr": "Carte de débit", "nl": "Debit kaart", "en": "Debit card"}
                            },
                            {
                                id: "creditcard",
                                label: {"fr": "Carte de crédit", "nl": "Credit kaart", "en": "Credit card"}
                            }
                        ]
                    },
                    invoiceTypes: {
                        type: Array,
                        value: () => [
                            {
                                id: "mutualfund",
                                label: {"fr": "Mutuelle", "nl": "Mutual", "en": "Mutual"}
                            },
                            {
                                id: "patient",
                                label: {"fr": "Patient", "nl": "Patient", "en": "Patient"}
                            },
                            {
                                id: "payingagency",
                                label: {"fr": "Autre organisme", "nl": "Anders", "en": "Paying agency"}
                            }
                        ]
                    },

                    sentMediumTypes: {
                        type: Array,
                        value: () => [
                            {
                                id: "paper",
                                label: {"fr": "Papier", "nl": "Papier", "en": "Paper"}
                            },
                            {
                                id: "efact",
                                label: {"fr": "e-Fact", "nl": "e-Fact", "en": "e-Fact"}
                            },
                            {
                                id: "eattest",
                                label: {"fr": "e-Attest", "nl": "e-Attest", "en": "e-Attest"}
                            },
                            {
                                id: "mediprima",
                                label: {"fr": "Mediprima", "nl": "Mediprima", "en": "Mediprima"}
                            }
                        ]
                    },


                    invoiceType_patient: {
                        type: Boolean,
                        value: false
                    },
                    invoiceType_mutualfund: {
                        type: Boolean,
                        value: false
                    },
                    invoiceType_others: {
                        type: Boolean,
                        value: false
                    },

                    sentMediumType_eattest: {
                        type: Boolean,
                        value: false
                    },
                    sentMediumType_efact: {
                        type: Boolean,
                        value: false
                    },
                    sentMediumType_mediprima: {
                        type: Boolean,
                        value: false
                    },
                    sentMediumType_paper: {
                        type: Boolean,
                        value: false
                    },

                    paymentType_cash: {
                        type: Boolean,
                        value: false
                    },
                    paymentType_debitcard: {
                        type: Boolean,
                        value: false
                    },
                    paymentType_creditcard: {
                        type: Boolean,
                        value: false
                    },
                    paymentType_wired: {
                        type: Boolean,
                        value: false
                    },
                }
            }

            static get observers() {
                return [
                    'filterInvoiceList(selectedHcpItem, dateFrom, dateTo)',
                    'filterInvoiceList(invoiceType_mutualfund, invoiceType_patient, invoiceType_others)',
                    'filterInvoiceList(sentMediumType_eattest, sentMediumType_efact, sentMediumType_mediprima, sentMediumType_paper)',
                    'filterInvoiceList(paymentType_cash, paymentType_debitcard, paymentType_creditcard, paymentType_wired)',
                ];
            }

            constructor() {
                super()
            }

            ready() {
                super.ready()
                this.refreshInvoiceList().then(x=> this.filterInvoiceList() )
            }

            _hcpFilterChanged(e){
                let latestSearchValue = e && e.detail.value;
                this.latestSearchValue = latestSearchValue;
                if (!latestSearchValue || latestSearchValue.length < 2) {
                    console.log("Cancelling empty search");
                    this.set('hcpListItem', []);
                    return;
                }
                this._hcpDataProvider() && this._hcpDataProvider().filter(latestSearchValue).then(res => {
                    if (latestSearchValue !== this.latestSearchValue) {
                        console.log("Cancelling obsolete search");
                        return;
                    }
                    this.set('hcpListItem', res.rows);
                });
            }

            _hcpDataProvider() {
                return {
                    filter: function (filterValue) {
                        const desc = 'desc';
                        let count = 15;
                        return Promise.all([this.api.hcparty().findByName(filterValue, null,  null, count, desc)]).then(results => {
                            const hcpList = results[0];
                            const filtered = _.flatten(hcpList.rows.filter(hcp => hcp.lastName && hcp.lastName !== "" || hcp.firstName && hcp.firstName !== "").map(hcp => ({id: hcp.id , name : hcp.lastName + ' ' +hcp.firstName}) ));
                            return { totalSize: filtered.length, rows: filtered };
                        });

                    }.bind(this)
                };
            }

            refreshInvoiceList() {
                return this.api.hcparty().getCurrentHealthcareParty().then(currentHcp  => {
                    return this.api.invoiceicc.listToPatients(currentHcp.parentId).then(invoices => {
                        return Promise.all(invoices.map(inv => this.api.crypto().extractCryptedFKs(inv, this.user.healthcarePartyId).then(ids => [inv, ids.extractedKeys[0]])))
                            .then(invAndIdsPat =>
                                this.api.patient().getPatientsWithUser(this.user, new models.ListOfIdsDto({ids: _.uniq(invAndIdsPat.map(x => x[1]))})).then(pats => invAndIdsPat.map(it => [it[0], pats.find(p => p.id === it[1])]))
                            ).then(invAndPats =>
                                this.api.insurance().getInsurances(new models.ListOfIdsDto({ids: _.uniq(_.flatten(invAndPats).filter(i => i.insurabilities).map(i => i && i.insurabilities && i.insurabilities[0] && i.insurabilities[0].insuranceId))})).then(ins => invAndPats.map(it => [it[0], it[1], ins.find(i => it && (it[0] && it[0].insurabilities && it[0].insurabilities[0] && i.id === it[1].insurabilities[0].insuranceId) || (it[1] && it[1].insurabilities && it[1].insurabilities.find(patIns => (it[0] && it[0].invoiceDate && patIns.startDate && patIns.endDate && it[0].invoiceDate >= patIns.startDate && it[0].invoiceDate <= patIns.endDate && patIns.insuranceId === i.id) || (!(it[0] && it[0].invoiceDate && patIns.startDate && patIns.endDate) && patIns.insuranceId === i.id))))]))
                            )
                            .then(invAndPats => {
                                return Promise.all(invAndPats.map(([invoice, pat, ins]) => {

                                    console.log("invoice:", invoice)
                                    const invdate = invoice.invoiceDate.toString()
                                    const item = {
                                        //author: after,
                                        date: invdate.substr(0, 4) + '-' + invdate.substr(4, 2) + '-' + invdate.substr(6, 2),
                                        //patient: after
                                        invoiceReference: invoice.invoiceReference,
                                        //oa: after
                                        //insurance: after
                                        invoiceType: this.getInvoiceTypeLabel(invoice.invoiceType),
                                        sentMediumType: this.getSentMediumTypeLabel(invoice.sentMediumType),
                                        //linkedConvention: for future use
                                        paymentType: this.getPaymentTypeLabel(invoice.paymentType),
                                        cash: 0,
                                        debitCard: 0,
                                        creditCard: 0,
                                        wired: 0,
                                        totalAmount: 0,

                                        invoice: invoice
                                    }

                                    const computeSum = function (paytype) {
                                        return invoice.invoicingCodes.filter(c => c.paymentType === paytype).reduce((acc, code) => {
                                            return acc + code.totalAmount
                                        }, 0) || 0
                                    }
                                    item.totalAmount = invoice.invoicingCodes.reduce((acc, code) => {
                                        return acc + code.totalAmount
                                    }, 0) || 0
                                    item.cash = computeSum('cash')
                                    item.debitCard = computeSum('debitCard')
                                    item.creditCard = computeSum('creditCard')
                                    item.wired = computeSum('wired')

                                    item.insurance = ins ? ins.code + ' ' + (ins.name["fr"] || ins.name["nl"]) : null
                                    item.oa = item.insurance ? item.insurance[0] + '00' : null
                                    item.patient = pat ? (pat.firstName + ' ' + pat.lastName) : null

                                    return this.api.user().getUser(invoice.author).then(user => {
                                        return this.api.hcparty().getHealthcareParty(user.healthcarePartyId).then(hcp => {
                                            item.author = hcp.lastName + ' ' + hcp.firstName
                                            item.authorHcpId = hcp.id
                                            return item
                                        })
                                    })
                                }))
                            }).then(invlist =>
                                this.set('invoiceItems', invlist)
                            )
                    })
                })
            }

            filterInvoiceList() {
                const invoiceTypeFilter = []
                if(this.invoiceType_mutualfund === true) {
                    invoiceTypeFilter.push("mutualfund")
                }
                if(this.invoiceType_patient === true) {
                    invoiceTypeFilter.push("patient")
                }
                if(this.invoiceType_others === true) {
                    invoiceTypeFilter.push("payingagency")
                }

                const sentMediumTypeFilter = []
                const icure_invoiceTypeFilter = [] // NOTE: icure use invoiceType instead of sentMediumType which is unused
                if(this.sentMediumType_eattest === true) {
                    sentMediumTypeFilter.push("eattest")
                    icure_invoiceTypeFilter.push("eattest")
                }
                if(this.sentMediumType_efact === true) {
                    sentMediumTypeFilter.push("efact")
                    icure_invoiceTypeFilter.push("efact")
                }
                if(this.sentMediumType_mediprima === true) {
                    sentMediumTypeFilter.push("mediprima")
                    icure_invoiceTypeFilter.push("mediprima")
                }
                if(this.sentMediumType_paper === true) {
                    sentMediumTypeFilter.push("paper")
                    icure_invoiceTypeFilter.push("paper")
                }

                const paymentTypeFilter = []
                if(this.paymentType_cash === true) {
                    paymentTypeFilter.push("cash")
                }
                if(this.paymentType_debitcard === true) {
                    paymentTypeFilter.push("debitcard")
                }
                if(this.paymentType_creditcard === true) {
                    paymentTypeFilter.push("creditcard")
                }
                if(this.paymentType_wired === true) {
                    paymentTypeFilter.push("wired")
                }

                this.set('filteredInvoiceItems', this.invoiceItems.filter(inv => {
                    let res = true
                    if(invoiceTypeFilter.length === 0) {
                        //res = true
                        // no checkbox checked, show all
                    } else {
                        res = res && invoiceTypeFilter.includes(inv.invoice.invoiceType)
                    }

                    if(sentMediumTypeFilter.length === 0) {
                        //res = true
                        // no checkbox checked, show all
                    } else {
                        res = res && (sentMediumTypeFilter.includes(inv.invoice.sentMediumType) || icure_invoiceTypeFilter.includes(inv.invoice.invoiceType))
                    }

                    if(paymentTypeFilter.length === 0) {
                        //res = true
                        // no checkbox checked, show all
                    } else {
                        res = res && paymentTypeFilter.includes(inv.invoice.paymentType)
                    }


                    if(this.selectedHcpItem != null) {
                        res = res && inv.authorHcpId === this.selectedHcpItem.id
                    }

                    if(this.dateFrom !== null && this.dateFrom !== "") {
                        res = res && inv.invoice.invoiceDate >= parseInt(this.dateFrom.replace("-", "").replace("-", ""), 10)
                    }

                    if(this.dateFrom !== null && this.dateTo !== "") {
                        res = res && inv.invoice.invoiceDate <= parseInt(this.dateTo.replace("-", "").replace("-", ""), 10)
                    }

                    return res
                }))
            }

            exportToCsv() {
                let items = null
                if(this.checkedInvoices.length > 0) {
                    items = this.checkedInvoices
                } else {
                    items = this.filteredInvoiceItems
                }
                this.generateXlsFile(items.map(inv => {
                    const xlinv = JSON.parse(JSON.stringify(inv));
                    if(this.isExportAnonyme) {
                        delete xlinv.patient
                    }
                    delete xlinv.invoice
                    delete xlinv.authorHcpId
                    return xlinv
                }))
            }

            generateXlsFile(data) {

                // Create xls work book and assign properties
                const xlsWorkBook = {SheetNames: [], Sheets: {}}
                xlsWorkBook.Props = {Title: "Patients list", Author: "iCure"}

                // Create sheet based on json data collection
                var xlsWorkSheet = XLSX.utils.json_to_sheet(data)

                // Link sheet to workbook
                XLSX.utils.book_append_sheet(xlsWorkBook, xlsWorkSheet, 'Patients list')

                // Virtual data output
                var xlsWorkBookOutput = new Buffer(XLSX.write(xlsWorkBook, {bookType: 'xls', type: 'buffer'}))

                // Put output to virtual "file"
                var fileBlob = new Blob([xlsWorkBookOutput], {type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})

                // Create download link and append to page's body
                var downloadLink = document.createElement("a")
                document.body.appendChild(downloadLink)
                downloadLink.style = "display: none"

                // Create url
                var urlObject = window.URL.createObjectURL(fileBlob)

                // Link to url
                downloadLink.href = urlObject
                downloadLink.download = "patients-list.xls"

                // Trigger download and drop object
                downloadLink.click()
                window.URL.revokeObjectURL(urlObject)

                // Free mem
                fileBlob = false
                xlsWorkBookOutput = false

                return
            }

            getSentMediumTypeLabel(aType){
                if(!aType) return;
                const type = this.sentMediumTypes.find(type => type.id === aType)
                return type && type.label && type.label[this.language]
            }

            getInvoiceTypeLabel(aType){
                if(!aType) return "";
                const type = this.invoiceTypes.find(type => type.id === aType)
                return type && type.label && type.label[this.language]
            }

            getPaymentTypeLabel(aType){
                if(!aType) return "";
                const type = this.paymentTypes.find(type => type.id === aType)
                return type && type.label && type.label[this.language]
            }

            _itemSelected(e) {
                if (e.path[0].checked) {
                    const checked = JSON.parse(e.target.dataset.item)
                    if (this.checkedInvoices.length !== this.invoiceItems.length) this.push('checkedInvoices', checked)
                } else {
                    this.splice('checkedInvoices', this.checkedInvoices.indexOf(e.target.dataset.item))
                    this.set('allSelected',false)
                }
                console.log(this.checkedInvoices.length+' checked',this.checkedInvoices)
            }


            _toggleSelectAll() {
                this.set('allSelected',this.allSelected != null ? !this.allSelected : true)
                this.set('checkedInvoices',this.allSelected ? this.filteredInvoiceItems : [])
                let invList = this.shadowRoot.querySelector('#invoiceGrid');
                let allCheckboxes = invList? invList.querySelectorAll('.list-checkbox') : []
                const selectedState = this.allSelected
                allCheckboxes.forEach(box=>{
                    box.checked = selectedState;
                })
            }
        }

        customElements.define(HtAdminReportsListOfAttestations.is, HtAdminReportsListOfAttestations)

    </script>
</dom-module>



