<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-styles/shadow.html">

<link rel="import" href="../pdf-element/pdf-element.html">
<link rel="import" href="../ht-spinner/ht-spinner.html">
<link rel="import" href="ht-services-list.html">

<dom-module id="dynamic-doc">
    <template>
        <style>
            ht-spinner.center  {
                position: absolute;
                left: calc(50% - 14px);
                top: calc(50% - 14px);
                height: 42px;
                width: 42px;
            }

            paper-card.subform-card {
                min-height: 16px;
                padding: 0 0 8px 0;
                box-shadow: none;
                border-bottom: 1px solid lightgrey;
                margin:0;
                width:100%;
                background:transparent;
            }

            .pat-details-card > .card-content {
                padding: 16px 16px 32px !important;
            }

            .pat-details-card {
                margin: 0 32px 32px;
                padding:0 8px 8px;
                overflow: hidden;
                width: calc(100% - 64px);
            }

            .pat-details-card.fullWidth {
                margin: 0 0 32px 0;
                width: 100%;
            }

            .pat-details-card hr {
                border: 1px solid var(--app-background-color-darker)
            }

            .horizontal {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                flex-basis: 100%;
            }

            .edit-pat-details-btn{
                position:absolute;
                left:50%;
                transform: translate(-50%,0);
                bottom:-20px;
                background: var(--app-secondary-color);
                border-radius:50%;
                @apply --shadow-elevation-4dp;
            }

            .justified {
                justify-content: space-between;
            }

            span.title {
                color:var(--app-primary-color);
                border-top: 2px solid rgba(231,231,231,1);
                border-radius: 2px 2px 0 0;
                background:rgba(0,0,0,0.1);
                font-size:12px;
                margin:0 0 8px -8px;
                padding:2px 24px;
                display:inline-block;
                width:calc(100% - 32px);
                text-align:left;
                word-break: break-word;
                height: 20px;
                line-height: 20px;
            }



            pdf-element {
                width: 100%;
                margin: auto;
            }
            .img-container{
                width:100%;
                height:100%;
                display:flex;
                justify-content: center;
                align-items: center;
                max-height:400px;
                overflow: hidden;
            }

            .img-container img{
                max-height:400px;
                align-self: center;
            }

            .txt-container {
                font-family: "Lucida Console","Lucida Sans","monospace",sans-serif;
                font-size: small;
                width: 100%;
                margin: 0;
                height: auto;
                max-height: 160px;
                padding: 8px;
                box-shadow: none;
                overflow-x: auto;
                overflow-y: auto;
                border: 1px solid var(--app-background-color-dark);
                background: var(--app-dark-color-faded);
                box-sizing: border-box;
            }

            .txt-container.bodyOfEmail {
                font-family: var(--paper-font-common-base_-_font-family);
                -webkit-font-smoothing: var(--paper-font-common-base_-_-webkit-font-smoothing);
                font-size: inherit;
                max-height: none;
                overflow-x: hidden;
                overflow-y: hidden;
                background: none;
                word-break:normal;
                white-space: pre-wrap;
                white-space: -moz-pre-wrap;
                white-space: -pre-wrap;
                white-space: -o-pre-wrap;
                word-wrap: break-word;
                border:0;
                padding-top:15px;
            }

            .pointers-line {
                display: flex;
                width: 100%;
                justify-content: space-between;
            }

            .hoverpointer {
                cursor: pointer;
                text-align: center;
                flex-grow: 1;
                margin: 8px 4px;
                border-radius: 4px;
                border: 1px solid var(--app-background-color-dark);
            }

            .resInfos {
                display: flex;
                flex-direction: column;
                background: var(--app-background-color-dark);
                border-radius: 4px;
                padding: 8px;
            }

            .resInfos h4 {
                margin: 0;
                text-align: center;
            }

            .resInfos .line {
                display: flex;
                flex-direction: row;
            }
            .resInfos .line .label {
                width: 96px;
                white-space: nowrap;
                text-overflow: ellipsis;
                display: block;
                padding-top: 4px;
                overflow: hidden;
            }
            .resInfos .line span {
                box-sizing: border-box;
                padding: 4px;
                background: white;
            }
            .resInfos .indicator {
                font-size: .85em;
                text-align: right;
            }

            pre.result {
                border: 1px solid var(--app-background-color-dark);
                border-radius: 4px;
                overflow-y: auto;
                overflow-x: auto;
                word-break: break-word;
                margin: 8px 0;
                padding: 4px;
                max-height: 400px;
            }

            .assignToPat {
                margin: 0 0 8px 0;
                width: 100%;
                transition: .25s ease-in-out;
                background: var(--app-secondary-color);
                box-shadow: var(--app-shadow-elevation-1);
            }
            .assignToPat:hover {
                background: var(--app-secondary-color-dark);
            }
            .assign-ico {
                position: absolute;
                right: 8px;
                top: 4px;
                padding: 4px;
                cursor: pointer;
                height: 32px;
                width: 32px;
                box-sizing: border-box;
                background: var(--app-secondary-color);
                border-radius: 50%;
            }
            .actionIcons {
                /* position: absolute;
                top: 0;
                right: 0;
                margin-left: 20px;
                min-width: 1px;
                color: var(--app-primary-color-dark);
                padding: .4em; */
            }
            .form-title {
                color: var(--app-primary-color);
                border-top: 2px solid var(--app-background-color-dark);
                border-radius: 2px 2px 0 0;
                background: var(--app-background-color-dark);
                font-size: 12px;
                margin: 0 0 8px -8px;
                padding: 2px 4px 2px 20px;
                display: flex;
                flex-flow: row nowrap;
                width: calc(100% - 8px);
                text-align: left;
                justify-content: space-between;
                align-items: center;
            }
            .form-title > span {
                flex-grow: 1;
                min-width: 100px;
            }

            .form-title >div {
                flex-grow: 0;
                min-width: 20px;
            }
            

        </style>

        <template is="dom-if" if="[[!isLabOrProtocol]]">
            <paper-card class$="pat-details-card [[_fullWidth(fullwidth)]]">

                <template is="dom-if" if="[[!_unknownMimeType(document.mainUti, document.otherUtis.*, dataUrl, data)]]">

                    <template is="dom-if" if="[[!documentId]]"><template is="dom-if" if="[[isLoading]]"><ht-spinner active></ht-spinner></template></template>

                    <template is="dom-if" if="[[_imageMimeType(document.mainUti, document.otherUtis.*, dataUrl, data)]]">
                        <div class="form-title">
                            [[_title(document.name, title)]]
                            <div>
                                <template is="dom-if" if="[[downloadable]]">
                                    <paper-button on-tap="_downloadAnnex" dataUrl$='[[item.dataUrl]]' class="actionIcons fowardIcon form-title-bar-btn" id="downloadFile"><iron-icon icon="file-download" dataUrl$='[[item.dataUrl]]'></iron-icon></paper-button>
                                    <paper-tooltip for="downloadFile" position="left">[[localize('dl','Download',language)]]</paper-tooltip>
                                </template>

                                <template is="dom-if" if="[[!_isEqual(document.documentLocation,'body')]]">
                                    <template is="dom-if" if="[[!isPatDetail]]">
                                        <template is="dom-if" if="[[!forceNoAssignation]]">
                                            <paper-button on-tap="openSuggestions" document$="[[item]]" document-id$="[[item.id]]" class="actionIcons form-title-bar-btn" id="assign-ico-lab"><iron-icon icon="icons:assignment-ind" document$="[[item]]" document-id$="[[item.id]]"></iron-icon></paper-button>
                                            <paper-tooltip for="assign-ico-lab" position="left">[[localize('assign_to_pat','Assign to a patient',language)]]</paper-tooltip>
                                        </template>
                                    </template>
                                </template>

                                <template is="dom-if" if="[[hubImportable]]">
                                    <paper-button on-tap="_importDocumentFromHub" data-document$="[[data]]" data-transaction$="[[transactionInfo]]" class="actionIcons fowardIcon form-title-bar-btn" id="downloadFileOnHub"><iron-icon icon="icons:cloud-download" data-document$="[[data]]" data-transaction$="[[transactionInfo]]" ></iron-icon></paper-button>
                                    <paper-tooltip for="downloadFileOnHub" position="left">[[localize('hub-down-fil-pat','Download file into patient folder',language)]]</paper-tooltip>
                                </template>

                                <template is="dom-if" if="[[hubUploadable]]">
                                    <paper-button on-tap="_uploadOnHubs" data-document-id$="[[document.id]]" class="actionIcons fowardIcon form-title-bar-btn" id="uploadFileOnHub"><iron-icon icon="icons:cloud-upload" data-document-id$="[[document.id]]"></iron-icon></paper-button>
                                    <paper-tooltip for="uploadFileOnHub" position="left">[[localize('hub-upl-fil','Upload file on hubs',language)]]</paper-tooltip>
                                </template>

                                <template is="dom-if" if="[[printable]]">
                                    <paper-button on-tap="_print" to-print="[[item]]" class="actionIcons fowardIcon form-title-bar-btn" id="printFile"><iron-icon to-print="[[item]]" icon="print"></iron-icon></paper-button>
                                    <paper-tooltip for="printFile" position="left">[[localize('print','Print',language)]]</paper-tooltip>
                                </template>

                                <template is="dom-if" if="[[forwardable]]">
                                    <paper-button on-tap="_forwardDocument" data-document-id$="[[document.id]]" class="actionIcons fowardIcon" id="forwardDocument"><iron-icon icon="arrow-forward" data-document-id$="[[document.id]]"> </iron-icon><iron-icon icon="mail" data-document-id$="[[document.id]]"></iron-icon></paper-button>
                                    <paper-tooltip for="forwardDocument" position="left">[[localize('forwardDocumentToColleague','Forward document to a colleague',language)]]</paper-tooltip>
                                </template>                            </div>
                        </div>
                        <template is="dom-if" if="[[isLoading]]"><ht-spinner active></ht-spinner></template>
                        <div class="img-container">
                            <img src$="[[_selectImageData(dataUrl, data)]]">
                        </div>
                    </template>

                    <template is="dom-if" if="[[_pdfMimeType(document.mainUti, document.otherUtis.*, dataUrl, data)]]">
                        <div class="form-title">
                            [[_title(document.name, title)]]
                            <div>
                                <template is="dom-if" if="[[downloadable]]">
                                    <paper-button on-tap="_downloadAnnex" dataUrl$='[[item.dataUrl]]' class="actionIcons fowardIcon form-title-bar-btn" id="downloadFile"><iron-icon icon="file-download" dataUrl$='[[item.dataUrl]]'></iron-icon></paper-button>
                                    <paper-tooltip for="downloadFile" position="left">[[localize('dl','Download',language)]]</paper-tooltip>
                                </template>

                                <template is="dom-if" if="[[!isPatDetail]]">
                                    <template is="dom-if" if="[[!forceNoAssignation]]">
                                        <paper-button on-tap="openSuggestions" document$="[[item]]" document-id$="[[item.id]]" class="actionIcons form-title-bar-btn" id="assign-ico-lab"><iron-icon icon="icons:assignment-ind" document$="[[item]]" document-id$="[[item.id]]"></iron-icon></paper-button>
                                        <paper-tooltip for="assign-ico-lab" position="left">[[localize('assign_to_pat','Assign to a patient',language)]]</paper-tooltip>
                                    </template>
                                </template>

                                <template is="dom-if" if="[[hubImportable]]">
                                    <paper-button on-tap="_importDocumentFromHub" data-document$="[[data]]" data-transaction$="[[transactionInfo]]" class="actionIcons fowardIcon form-title-bar-btn" id="downloadFileOnHub"><iron-icon icon="icons:cloud-download" data-document$="[[data]]" data-transaction$="[[transactionInfo]]" ></iron-icon></paper-button>
                                    <paper-tooltip for="downloadFileOnHub" position="left">[[localize('hub-down-fil-pat','Download file into patient folder',language)]]</paper-tooltip>
                                </template>

                                <template is="dom-if" if="[[hubUploadable]]">
                                    <paper-button on-tap="_uploadOnHubs" data-document-id$="[[document.id]]" class="actionIcons fowardIcon form-title-bar-btn" id="uploadFileOnHub"><iron-icon icon="icons:cloud-upload" data-document-id$="[[document.id]]"></iron-icon></paper-button>
                                    <paper-tooltip for="uploadFileOnHub" position="left">[[localize('hub-upl-fil','Upload file on hubs',language)]]</paper-tooltip>
                                </template>

                                <template is="dom-if" if="[[printable]]">
                                    <paper-button on-tap="_print" to-print="[[item]]" class="actionIcons fowardIcon form-title-bar-btn" id="printFile"><iron-icon to-print="[[item]]" icon="print"></iron-icon></paper-button>
                                    <paper-tooltip for="printFile" position="left">[[localize('print','Print',language)]]</paper-tooltip>
                                </template>

                                <template is="dom-if" if="[[forwardable]]">
                                    <paper-button on-tap="_forwardDocument" data-document-id$="[[document.id]]" class="actionIcons fowardIcon" id="forwardDocument"><iron-icon icon="arrow-forward" data-document-id$="[[document.id]]"> </iron-icon><iron-icon icon="mail" data-document-id$="[[document.id]]"></iron-icon></paper-button>
                                    <paper-tooltip for="forwardDocument" position="left">[[localize('forwardDocumentToColleague','Forward document to a colleague',language)]]</paper-tooltip>
                                </template>
                            </div>
                        </div>
                        <template is="dom-if" if="[[isLoading]]"><ht-spinner active></ht-spinner></template>
                        <pdf-element src="[[_selectData(dataUrl, data)]]" elevation="5" downloadable fit-width fit-height enable-text-selection></pdf-element>
                    </template>

                    <template is="dom-if" if="[[_xmlMimeType(document.mainUti, document.otherUtis.*, dataUrl, data)]]">
                        <div class="form-title">
                            [[_title(document.name, title)]]
                            <div>
                                <template is="dom-if" if="[[downloadable]]">
                                    <paper-button on-tap="_downloadAnnex" dataUrl$='[[item.dataUrl]]' class="actionIcons fowardIcon form-title-bar-btn" id="downloadFile"><iron-icon icon="file-download" dataUrl$='[[item.dataUrl]]'></iron-icon></paper-button>
                                    <paper-tooltip for="downloadFile" position="left">[[localize('dl','Download',language)]]</paper-tooltip>
                                </template>

                                <template is="dom-if" if="[[!isPatDetail]]">
                                    <template is="dom-if" if="[[!forceNoAssignation]]">
                                        <paper-button on-tap="openSuggestions" document$="[[item]]" document-id$="[[item.id]]" class="actionIcons form-title-bar-btn" id="assign-ico-lab"><iron-icon icon="icons:assignment-ind" document$="[[item]]" document-id$="[[item.id]]"></iron-icon></paper-button>
                                        <paper-tooltip for="assign-ico-lab" position="left">[[localize('assign_to_pat','Assign to a patient',language)]]</paper-tooltip>
                                    </template>
                                </template>

                                <template is="dom-if" if="[[hubImportable]]">
                                    <paper-button on-tap="_importDocumentFromHub" data-document$="[[data]]" data-transaction$="[[transactionInfo]]" class="actionIcons fowardIcon form-title-bar-btn" id="downloadFileOnHub"><iron-icon icon="icons:cloud-download" data-document$="[[data]]" data-transaction$="[[transactionInfo]]" ></iron-icon></paper-button>
                                    <paper-tooltip for="downloadFileOnHub" position="left">[[localize('hub-down-fil-pat','Download file into patient folder',language)]]</paper-tooltip>
                                </template>

                                <template is="dom-if" if="[[hubUploadable]]">
                                    <paper-button on-tap="_uploadOnHubs" data-document-id$="[[document.id]]" class="actionIcons fowardIcon form-title-bar-btn" id="uploadFileOnHub"><iron-icon icon="icons:cloud-upload" data-document-id$="[[document.id]]"></iron-icon></paper-button>
                                    <paper-tooltip for="uploadFileOnHub" position="left">[[localize('hub-upl-fil','Upload file on hubs',language)]]</paper-tooltip>
                                </template>

                                <template is="dom-if" if="[[printable]]">
                                    <paper-button on-tap="_print" to-print="[[item]]" class="actionIcons fowardIcon form-title-bar-btn" id="printFile"><iron-icon to-print="[[item]]" icon="print"></iron-icon></paper-button>
                                    <paper-tooltip for="printFile" position="left">[[localize('print','Print',language)]]</paper-tooltip>
                                </template>

                                <template is="dom-if" if="[[forwardable]]">
                                    <paper-button on-tap="_forwardDocument" data-document-id$="[[document.id]]" class="actionIcons fowardIcon" id="forwardDocument"><iron-icon icon="arrow-forward" data-document-id$="[[document.id]]"> </iron-icon><iron-icon icon="mail" data-document-id$="[[document.id]]"></iron-icon></paper-button>
                                    <paper-tooltip for="forwardDocument" position="left">[[localize('forwardDocumentToColleague','Forward document to a colleague',language)]]</paper-tooltip>
                                </template>

                            </div>
                        </div>
                    </template>

                </template>

                <template is="dom-if" if="[[_pdfRenderableMimeType(document.mainUti, document.otherUtis.*, null, data)]]">
                    <div class="form-title">PDF renderable [[_title(document.name, title)]]</div>
                    <template is="dom-if" if="[[isLoading]]"><ht-spinner active></ht-spinner></template>
                    <pdf-element src="[[pdfData]]" elevation="5" downloadable fit-width fit-height enable-text-selection></pdf-element>
                </template>


                <template is="dom-if" if="[[_urlMimeType(document.mainUti, document.otherUtis.*, null, data)]]">
                    <span class="title">URL [[_title(document.name, title)]]</span>
                    <template is="dom-if" if="[[isLoading]]"><ht-spinner active></ht-spinner></template>
                    <p><a href="[[data.url]]" target="_blank">External link</a></p>
                </template>


                <template is="dom-if" if="[[_plainMimeType(document.mainUti, document.otherUtis.*, null, data)]]">
                    <template is="dom-if" if="[[attachmentContent.length]]">

                        <template is="dom-if" if="[[!isBodyTextOfEmail]]">
                            <div class="form-title">
                                [[_title(document.name, title)]]
                                <div>
                                    <template is="dom-if" if="[[downloadable]]">
                                        <paper-button on-tap="_downloadAnnex" dataUrl$='[[item.dataUrl]]' class="actionIcons fowardIcon form-title-bar-btn" id="downloadFile"><iron-icon icon="file-download" dataUrl$='[[item.dataUrl]]'></iron-icon></paper-button>
                                        <paper-tooltip for="downloadFile" position="left">[[localize('dl','Download',language)]]</paper-tooltip>
                                    </template>
                                    <template is="dom-if" if="[[!isPatDetail]]">
                                        <template is="dom-if" if="[[!forceNoAssignation]]">
                                            <paper-button on-tap="openSuggestions" document$="[[item]]" document-id$="[[item.id]]" class="actionIcons form-title-bar-btn" id="assign-ico-lab"><iron-icon icon="icons:assignment-ind" document$="[[item]]" document-id$="[[item.id]]"></iron-icon></paper-button>
                                            <paper-tooltip for="assign-ico-lab" position="left">[[localize('assign_to_pat','Assign to a patient',language)]]</paper-tooltip>
                                        </template>
                                    </template>
                                    <template is="dom-if" if="[[printable]]">
                                        <paper-button on-tap="_print" to-print="[[item]]" class="actionIcons fowardIcon form-title-bar-btn" id="printFile"><iron-icon to-print="[[item]]" icon="print"></iron-icon></paper-button>
                                        <paper-tooltip for="printFile" position="left">[[localize('print','Print',language)]]</paper-tooltip>
                                    </template>
                                    <template is="dom-if" if="[[forwardable]]">
                                        <paper-icon-button on-tap="_forwardDocument" data-document-id$="[[document.id]]" class="actionIcons fowardIcon form-title-bar-btn" id="forwardDocument" icon="forward" data-document-id$="[[document.id]]"></paper-icon-button>
                                        <paper-tooltip for="forwardDocument" position="left">[[localize('forwardDocumentToColleague','Forward document to a colleague',language)]]</paper-tooltip>
                                    </template>
                                </div>
                            </div>
                            <template is="dom-if" if="[[isLoading]]"><ht-spinner active></ht-spinner></template>
                            <template is="dom-if" if="[[preview]]"><pre class="txt-container">[[attachmentContent]]</pre></template>
                        </template>

                        <template is="dom-if" if="[[isBodyTextOfEmail]]"><pre class="txt-container bodyOfEmail">[[attachmentContent]]</pre></template>

                    </template>

                </template>

                <template is="dom-if" if="[[_unknownMimeType(document.mainUti, document.otherUtis.*, dataUrl, data)]]">
                    <div class="form-title">
                        [[_title(document.name, title)]]
                        <div>
                            <template is="dom-if" if="[[downloadable]]">
                                <paper-button on-tap="_downloadAnnex" dataUrl$='[[item.dataUrl]]' class="actionIcons fowardIcon form-title-bar-btn" id="downloadFile"><iron-icon icon="file-download" dataUrl$='[[item.dataUrl]]'></iron-icon></paper-button>
                                <paper-tooltip for="downloadFile" position="left">[[localize('dl','Download',language)]]</paper-tooltip>
                            </template>

                            <template is="dom-if" if="[[!isPatDetail]]">
                                <template is="dom-if" if="[[!forceNoAssignation]]">
                                    <paper-button on-tap="openSuggestions" document$="[[item]]" document-id$="[[item.id]]" class="actionIcons form-title-bar-btn" id="assign-ico-lab"><iron-icon icon="icons:assignment-ind" document$="[[item]]" document-id$="[[item.id]]"></iron-icon></paper-button>
                                    <paper-tooltip for="assign-ico-lab" position="left">[[localize('assign_to_pat','Assign to a patient',language)]]</paper-tooltip>
                                </template>
                            </template>

                            <template is="dom-if" if="[[hubImportable]]">
                                <paper-button on-tap="_importDocumentFromHub" data-document$="[[data]]" data-transaction$="[[transactionInfo]]" class="actionIcons fowardIcon form-title-bar-btn" id="downloadFileOnHub"><iron-icon icon="icons:cloud-download" data-document$="[[data]]" data-transaction$="[[transactionInfo]]" ></iron-icon></paper-button>
                                <paper-tooltip for="downloadFileOnHub" position="left">[[localize('hub-down-fil-pat','Download file into patient folder',language)]]</paper-tooltip>
                            </template>

                            <template is="dom-if" if="[[hubUploadable]]">
                                <paper-button on-tap="_uploadOnHubs" data-document-id$="[[document.id]]" class="actionIcons fowardIcon form-title-bar-btn" id="uploadFileOnHub"><iron-icon icon="icons:cloud-upload" data-document-id$="[[document.id]]"></iron-icon></paper-button>
                                <paper-tooltip for="uploadFileOnHub" position="left">[[localize('hub-upl-fil','Upload file on hubs',language)]]</paper-tooltip>
                            </template>

                            <template is="dom-if" if="[[printable]]">
                                <paper-button on-tap="_print" to-print="[[item]]" class="actionIcons fowardIcon form-title-bar-btn" id="printFile"><iron-icon to-print="[[item]]" icon="print"></iron-icon></paper-button>
                                <paper-tooltip for="printFile" position="left">[[localize('print','Print',language)]]</paper-tooltip>
                            </template>

                            <template is="dom-if" if="[[forwardable]]">
                                <paper-icon-button on-tap="_forwardDocument" data-document-id$="[[document.id]]" class="actionIcons fowardIcon form-title-bar-btn" id="forwardDocument" icon="forward" data-document-id$="[[document.id]]"></paper-icon-button>
                                <paper-tooltip for="forwardDocument" position="left">[[localize('forwardDocumentToColleague','Forward document to a colleague',language)]]</paper-tooltip>
                            </template>
                        </div>
                    </div>
                    <template is="dom-if" if="[[isLoading]]"><ht-spinner active></ht-spinner></template>
                </template>

            </paper-card>
        </template>



        <template is="dom-if" if="[[isLabOrProtocol]]">
            <paper-card class$="pat-details-card [[_fullWidth(fullwidth)]]">
                <div class="form-title">
                    [[_title(document.name, title)]]
                    <div>
                        <template is="dom-if" if="[[downloadable]]">
                            <paper-button on-tap="_downloadAnnex" dataUrl$='[[item.dataUrl]]' class="actionIcons fowardIcon form-title-bar-btn" id="downloadFile"><iron-icon icon="file-download" dataUrl$='[[item.dataUrl]]'></iron-icon></paper-button>
                            <paper-tooltip for="downloadFile" position="left">[[localize('dl','Download',language)]]</paper-tooltip>
                        </template>

                        <template is="dom-if" if="[[!isPatDetail]]">
                            <template is="dom-if" if="[[!forceNoAssignation]]">
                                <paper-button on-tap="openSuggestions" document$="[[item]]" document-id$="[[item.id]]" class="actionIcons form-title-bar-btn" id="assign-ico-lab"><iron-icon icon="icons:assignment-ind" document$="[[item]]" document-id$="[[item.id]]"></iron-icon></paper-button>
                                <paper-tooltip for="assign-ico-lab" position="left">[[localize('assign_to_pat','Assign to a patient',language)]]</paper-tooltip>
                            </template>
                        </template>

                        <template is="dom-if" if="[[hubImportable]]">
                            <paper-button on-tap="_importDocumentFromHub" data-document$="[[data]]" data-transaction$="[[transactionInfo]]" class="actionIcons fowardIcon form-title-bar-btn" id="downloadFileOnHub"><iron-icon icon="icons:cloud-download" data-document$="[[data]]" data-transaction$="[[transactionInfo]]" ></iron-icon></paper-button>
                            <paper-tooltip for="downloadFileOnHub" position="left">[[localize('hub-down-fil-pat','Download file into patient folder',language)]]</paper-tooltip>
                        </template>

                        <template is="dom-if" if="[[hubUploadable]]">
                            <paper-button on-tap="_uploadOnHubs" data-document-id$="[[document.id]]" class="actionIcons fowardIcon form-title-bar-btn" id="uploadFileOnHub"><iron-icon icon="icons:cloud-upload" data-document-id$="[[document.id]]"></iron-icon></paper-button>
                            <paper-tooltip for="uploadFileOnHub" position="left">[[localize('hub-upl-fil','Upload file on hubs',language)]]</paper-tooltip>
                        </template>

                        <template is="dom-if" if="[[printable]]">
                            <paper-button on-tap="_print" to-print="[[item]]" class="actionIcons fowardIcon form-title-bar-btn" id="printFile"><iron-icon to-print="[[item]]" icon="print"></iron-icon></paper-button>
                            <paper-tooltip for="printFile" position="left">[[localize('print','Print',language)]]</paper-tooltip>
                        </template>
                        <template is="dom-if" if="[[forwardable]]">
                            <paper-button on-tap="_forwardDocument" data-document-id$="[[document.id]]" class="actionIcons fowardIcon" id="forwardDocument"><iron-icon icon="arrow-forward" data-document-id$="[[document.id]]"> </iron-icon><iron-icon icon="mail" data-document-id$="[[document.id]]"></iron-icon></paper-button>
                            <paper-tooltip for="forwardDocument" position="left">[[localize('forwardDocumentToColleague','Forward document to a colleague',language)]]</paper-tooltip>
                        </template>
                    </div>
                </div>

                <template is="dom-if" if="[[isLoading]]"><ht-spinner active></ht-spinner></template>

                <template is="dom-repeat" items="[[labOrProtocolContent]]" as="resInfo">
                    <div class="resInfos">
                        <h4>[[resInfo.sex]]. [[resInfo.firstName]] [[resInfo.lastName]]</h4>
                        <div class="line"><b class="label">[[localize('document','Document',language)]]</b><span>[[resInfo.protocol]] - [[resInfo.labo]]</span></div>
                        <div class="line"><b class="label">[[localize('date','Date',language)]]</b><span>[[_formatDate(resInfo.demandDate)]]</span></div>
                        <template is="dom-if" if="[[resInfo.complete]]">
                            <div class="indicator"><iron-icon icon="check"></iron-icon> [[localize('com_res','Complete result',language)]]</div>
                        </template>
                        <template is="dom-if" if="[[!resInfo.complete]]">
                            <div class="indicator"><iron-icon icon="info"></iron-icon> [[localize('inc_res','Incomplete result',language)]]</div>
                        </template>
                    </div>
                    <template is="dom-if" if="[[_moreThan2(resInfo.services)]]">
                        <ht-services-list id="dynamicallyListForm" api="[[api]]" user="[[user]]" contacts="[[_wrap(resInfo)]]" i18n="[[i18n]]" language="[[language]]" resources="[[resources]]"></ht-services-list>
                    </template>
                    <template is="dom-if" if="[[!_moreThan2(resInfo.services)]]">
                        <template is="dom-if" if="[[_serviceDescription(resInfo.services.1)]]">
                            <div class="line-flex">
                                <div class="label">[[_serviceDescription(resInfo.services.0)]]</div>
                                <pre class="result">[[_serviceDescription(resInfo.services.1)]]</pre>
                            </div>
                        </template>
                        <template is="dom-if" if="[[!_serviceDescription(resInfo.services.1)]]">
                            <div class="line-flex">
                                <pre class="result">[[_serviceDescription(resInfo.services.0)]]</pre>
                            </div>
                        </template>
                    </template>
                </template>
            </paper-card>
        </template>

    </template>

    <script>
        import XML from 'parse-xml/dist/parse-xml';
        import mustache from "mustache/mustache.js";
        import moment from 'moment/src/moment';
        import base64js from 'base64-js';

        class DynamicDoc extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'dynamic-doc';
            }

            static get properties() {
                return {
                    api: {
                        type: Object
                    },
                    user: {
                        type: Object
                    },
                    documentId: {
                        type: String,
                        value: null
                    },
                    downloadable:{
                        type: Boolean
                    },
                    forwardable:{
                        type: Boolean,
                        value: false
                    },
                    hubUploadable: {
                      type: Boolean,
                      value: false
                    },
                    hubImportable:{
                        type: Boolean,
                        value: false
                    },
                    printable: {
                        type: Boolean,
                        value: false
                    },
                    isBodyTextOfEmail:{
                        type: Boolean,
                        value: false
                    },
                    preview:{
                        type: Boolean
                    },
                    document: {
                        type: Object,
                        value: null
                    },
                    documentAttachment:{
                        type: String,
                        value: null
                    },
                    dataUrl: {
                        type: String,
                        value: null
                    },
                    data: {
                        type: Object
                    },
                    pdfData: {
                        type: Object
                    },

                    title: {
                        type: String,
                        value: null
                    },
                    showDetail:{
                        type: Boolean,
                        value: false
                    },
                    type:{
                        type: String,
                        value: null
                    },
                    isLabOrProtocol: {
                        type: Boolean,
                        value: true
                    },
                    unassigned: {
                        type: Object,
                        value: []
                    },
                    isPatDetail: {
                        type: Boolean,
                        value: false
                    },
                    forceNoAssignation: {
                        type: Boolean,
                        value: false
                    },
                    isLoading: {
                        type: Boolean,
                        value: false
                    },
                    fullwidth: {
                        type: Boolean,
                        value: false
                    },
                    transactionInfo:{
                        type: Object,
                        value: () => {}
                    }

                };
            }

            static get observers() {
                return ['_documentIdChanged(documentId, api, user)','_dataUrlChanged(dataUrl)', '_dataChanged(data)']
            }

            constructor() {
                super();
            }

            ready() {
                super.ready()
            }

            _title(name, fallback) {
                return name && name !== 'No title' ? name : fallback
            }

            openSuggestions() {
                this.dispatchEvent(new CustomEvent('open-suggestions', {detail: {documentId: this.documentId}, bubbles: true, composed: true}))
            }

            _documentIdChanged() {
                if (!this.documentId || !this.api || !this.user) {
                    this.set('isLoading',false)
                    return;
                }
                this.set('isLoading',true)
                const docId = this.documentId
                this.api.document().getDocument(docId).then(doc => {
                    this.set('document', doc)
                    if (_.size(doc.encryptionKeys) || _.size(doc.delegations)) {
                        this.api.crypto().extractKeysFromDelegationsForHcpHierarchy(this.user.healthcarePartyId, doc.id, _.size(doc.encryptionKeys) ? doc.encryptionKeys : doc.delegations
                        ).then(({extractedKeys: enckeys}) => {
                            const url = doc && this.api.document().getAttachmentUrl(doc.id, doc.attachmentId, enckeys, this.api.sessionId)
                            this.set('dataUrl', url)
                            this.set('isLoading',false)
                        }).catch(() => {
                            const url = doc && this.api.document().getAttachmentUrl(doc.id, doc.attachmentId, undefined, this.api.sessionId)
                            this.set('dataUrl', url)
                            this.set('isLoading',false)
                        })
                    } else {
                        const url = doc && this.api.document().getAttachmentUrl(doc.id, doc.attachmentId, undefined, this.api.sessionId)
                        this.set('dataUrl', url)
                        this.set('isLoading',false)
                    }
                })
            }
            _downloadAnnex(){
                const doc = this.document
                if (doc && (_.size(doc.encryptionKeys) || _.size(doc.delegations))) {
                    this.api.crypto().extractKeysFromDelegationsForHcpHierarchy(this.user.healthcarePartyId, doc.id, _.size(doc.encryptionKeys) ? doc.encryptionKeys : doc.delegations
                    ).then(({extractedKeys: enckeys}) => {
                        const utiExt = doc.mainUti && doc.mainUti.split(".").length ? doc.mainUti.split(".")[1] : undefined
                        const docExt = doc.name  && doc.name.split(".").length ? doc.name.split(".")[1] : undefined
                        const docName = !docExt && utiExt ? doc.name + "." + utiExt : doc.name
                        const url = doc && this.api.document().getAttachmentUrl(doc.id,doc.attachmentId,enckeys,this.api.sessionId,docName)
                        let a = document.createElement("a");
                        document.body.appendChild(a);
                        this.appendChild(a);
                        a.style = "display: none";
                        a.download = doc.name // optional
                        a.setAttribute('href', url);
                        a.click();
                        window.URL.revokeObjectURL(url);
                    })
                } else {
                    if(this.data && this.data.value){
                        let image_data = atob(this.data.value);
                        let arraybuffer = new ArrayBuffer(image_data.length);
                        let view = new Uint8Array(arraybuffer);
                        for (let i=0; i<image_data.length; i++) {
                            view[i] = image_data.charCodeAt(i) & 0xff;
                        }
                        let blob = new Blob([arraybuffer], {type: 'application/octet-stream'});

                        let url = window.URL.createObjectURL(blob)
                        let a = document.createElement("a");
                        this.appendChild(a);
                        a.style = "display: none";
                        a.href = url;
                        if(this.data && this.data.mediatype && this.data.mediatype === "IMAGE_JPEG"){
                            a.download = `${"image"}_${moment()}.jpeg`;
                        }else {
                            a.download = `${"image"}_${moment()}.png`;
                        }
                        a.click();
                        this.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    } else if(this.dataUrl){
                        console.log("dataUrl : ", this.dataUrl)
                    }
                }

            }

            _print(e) {
                const target = this.document || null
                if (target) {
                    this.api.pdfReport(null,{}).then(({pdf:data, printed:printed}) =>{ // TODO format print
                        if (!printed) {
                            let blob = new Blob([data],{type :'application/pdf'});

                            let url = window.URL.createObjectURL(blob)

                            let a = document.createElement("a");
                            document.body.appendChild(a);
                            a.style = "display: none";

                            a.href = url;
                            a.download = this.selectedInvoice.id+moment()+".pdf";
                            a.click();
                            window.URL.revokeObjectURL(url);
                        }
                    })
                }
            }

            _imageMimeType(uti, utis, dataUrl, data) {
                return data && data.mediatype ? data.mediatype === "IMAGE_PNG" || data.mediatype === "IMAGE_JPEG"  : (data || dataUrl) && (uti && [uti] || []).concat(utis || []).map(u => this.mimeType(u)).find(m => m && (m.startsWith('image/') || m === 'public/jpeg'));
            }

            _pdfMimeType(uti, utis, dataUrl, data) {
                return data && data.mediatype ? data.mediatype === "APPLICATION_PDF" : (data || dataUrl) && (uti && [uti] || []).concat(utis || []).map(u=>this.mimeType(u)).find(m=>m === 'application/pdf');
            }

            _xmlMimeType(uti, utis) {
                return (uti && [uti] || []).concat(utis || []).map(u => this.mimeType(u)).find(m => m === 'text/xml' || m === 'application/xml');
            }

            _plainMimeType(uti, utis, isLabOrProtocol, data) {
                return !isLabOrProtocol && (uti && [uti] || []).concat(utis || []).map(u => this.mimeType(u)).find(m => m === 'text/plain');
            }

            _pdfRenderableMimeType(uti, utis, isLabOrProtocol, data){
                return data && data.content && (data.l || data.l === null) ? data.content.length : false;//this._plainMimeType(uti, utis, isLabOrProtocol, data);
            }

            _urlMimeType(uti, utis, isLabOrProtocol, data){
                return data && data.mediatype ? data.mediatype === "TEXT_HTML" : false
            }

            _unknownMimeType(uti, utis, dataUrl, data) {
                return (!this._imageMimeType(uti, utis, dataUrl, data) && !this._pdfMimeType(uti, utis, dataUrl, data) && !this._xmlMimeType(uti, utis)
                    && !this._plainMimeType(uti, utis)&& !this._pdfRenderableMimeType(uti, utis, null, data)
                    && !this._urlMimeType(uti, utis, null, data))
            }

            _dataUrlChanged(dataUrl) {
                if (dataUrl && dataUrl.length && this.document && this.document.mainUti !== "com.adobe.pdf" && this.document.mainUti !== "public.jpeg" && this.document.mainUti !== "public.png") {
                    this.api.crypto()
                        .extractKeysFromDelegationsForHcpHierarchy(
                            this.user.healthcarePartyId,
                            this.document.id,
                            _.size(this.document.encryptionKeys) ? this.document.encryptionKeys : this.document.delegations
                        )
                        .then(({extractedKeys: enckeys}) => {
                            this.api.beresultimport().canHandle(this.document.id, enckeys.join(',')).then(isResult => {
                                if (isResult) {
                                    this.set('isLabOrProtocol', true)
                                    this.api.beresultimport().getInfos(this.document.id, true, this.language || 'fr', enckeys.join(','))
                                        .then(res => {
                                            this.set('labOrProtocolContent', res)
                                        })
                                } else {
                                    this.set('isLabOrProtocol', false)
                                    this.api.shortLivedCache(dataUrl, () => fetch(dataUrl, {credentials: 'include'})
                                        .then(response => response.text()))
                                        .then(text => {
                                            this.set('attachmentContent', text)
                                        })

                                }
                            }).catch((e) => console.log('Handle error: ', e))
                        })
                }else{
                    this.set('isLabOrProtocol', false)
                }
            }

            _dataChanged(data) {
                if (data) {
                    this.set('isLabOrProtocol', false)
                    this.set('attachmentContent', data && data.value ? data.value : data)
                    this.set('isLoading',false)
                    if(data && data.content && (data.l || data.l === null)){
                        this._renderData(data);
                    }
                } else {
                    this.set('isLabOrProtocol', false)
                }
            }

            _selectData(dataUrl, data){
                //data.value: kmehr lnk element
                return dataUrl ? dataUrl : (data.value ? data.value : data);
            }

            _selectImageData(dataUrl, data){
                //data.value: kmehr lnk element
                //"data:image/png;base64, BASE64DATA...=="
                return dataUrl ? dataUrl : (data.value ? "data:image/png;base64, " + data.value : data);
            }

            mimeType(u){
                return u === 'public.plainText' ? 'text/plain' : this.api.document().mimeType(u)
            }

            _base64(data) {
                return base64js.fromByteArray(data);
            }

            _getAttachment(){
                this.showDetail = !this.showDetail
            }

            _formatDate(date) {
                return date && this.api.moment(date).format(date > 99991231 ? 'DD/MM/YYYY HH:mm' : 'DD/MM/YYYY')
            }

            _wrap(o) { return [o] }

            _moreThan2(items) {
                return items && items.length > 2
            }

            _serviceDescription(svc) {
                return svc && this.api.contact().shortServiceDescription(svc, this.language) ||''
            }

            _isEqual(a,b) {
                return a === b
            }

            _renderData(data){
                if(data && data.content) {this._renderHtmlAsPDF(_.join(data.content), "doc").then(({pdf:data}) =>{
                    this.set("pdfData", this._arrayBufferToBase64(data));
                });
                }
            }

            _arrayBufferToBase64( buffer ) {
                var binary = '';
                var bytes = new Uint8Array( buffer );
                var len = bytes.byteLength;
                for (var i = 0; i < len; i++) {
                    binary += String.fromCharCode( bytes[ i ] );
                }
                return window.btoa( binary );
            }

            _renderHtmlAsPDF(html, filename){
                const pdfData = {type : "doc-off-format"};
                let pdfTemplate = html;
                return this.api.pdfReport(mustache.render(pdfTemplate, pdfData));
            }
            _uploadOnHubs(e){
                const documentId = _.get(e,"target.dataset.documentId", false);
                return !!documentId ? this.dispatchEvent(new CustomEvent('upload-document', { composed: true, bubbles: true, detail: { documentId:documentId } })) : false;
            }

            _importDocumentFromHub(e){
                if(e.target && e.target.dataset && e.target.dataset.document && e.target.dataset.transaction){
                    this.dispatchEvent(new CustomEvent('import-hub-document', { composed: true, bubbles: true, detail: { document: e.target.dataset.document, transaction:  e.target.dataset.transaction} }))
                }
            }

            _forwardDocument(e) {
                const documentId = _.get(e,"target.dataset.documentId", false);
                return !!documentId ? this.dispatchEvent(new CustomEvent('forward-document', { composed: true, bubbles: true, detail: { documentId:documentId } })) : false;
            }

            _fullWidth(inputData) {
                return !!inputData ? "fullWidth" : ""
            }
        }

        customElements.define(DynamicDoc.is, DynamicDoc);
    </script>
</dom-module>
